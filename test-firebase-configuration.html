<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Storage Configuration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); border: 1px solid #4CAF50; }
        .status.error { background: rgba(244, 67, 54, 0.3); border: 1px solid #f44336; }
        .status.warning { background: rgba(255, 193, 7, 0.3); border: 1px solid #FFC107; color: #333; }
        .status.info { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6236ff, #9c6bff);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(98, 54, 255, 0.4);
        }
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6236ff, #9c6bff);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log .timestamp {
            color: #4CAF50;
            font-weight: bold;
        }
        .log .level {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 8px;
        }
        .log .level.INFO { background: #2196F3; }
        .log .level.SUCCESS { background: #4CAF50; }
        .log .level.ERROR { background: #f44336; }
        .log .level.WARNING { background: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Storage Configuration Test</h1>
        <p>Esta p√°gina verifica la configuraci√≥n de Firebase Storage y las reglas de seguridad.</p>

        <!-- Estado de conexi√≥n a Firebase -->
        <div class="test-section">
            <h2>üì° Estado de Conexi√≥n Firebase</h2>
            <div id="connectionStatus" class="status info">üîÑ Verificando conexi√≥n...</div>
            <div id="authStatus" class="status info">üîÑ Verificando autenticaci√≥n...</div>
            <div id="storageStatus" class="status info">üîÑ Verificando Storage...</div>
        </div>

        <!-- Test de autenticaci√≥n -->
        <div class="test-section">
            <h2>üîê Test de Autenticaci√≥n</h2>
            <p>Debes estar autenticado para subir archivos.</p>
            <div id="userInfo"></div>
            <button id="loginBtn" class="btn btn-primary" onclick="testLogin()">üîë Iniciar Sesi√≥n de Prueba</button>
            <button id="logoutBtn" class="btn btn-primary" onclick="testLogout()" style="display: none;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Test de subida de archivos -->
        <div class="test-section">
            <h2>üì§ Test de Subida de Archivos</h2>
            <div class="upload-area" onclick="document.getElementById('testFile').click()">
                <div>üìÅ Haz clic para seleccionar un archivo de prueba</div>
                <small>PNG, JPG, ZIP - M√°ximo 10MB</small>
            </div>
            <input type="file" id="testFile" style="display: none;" accept="image/*,.zip" onchange="handleFileSelect(event)">
            
            <div id="fileInfo" style="display: none; margin: 15px 0; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;"></div>
            
            <div id="uploadProgress" class="progress-container" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <button id="uploadBtn" class="btn btn-primary" onclick="testUpload()" disabled>
                üì§ Subir Archivo de Prueba
            </button>
            
            <div id="uploadResult" style="margin-top: 15px;"></div>
        </div>

        <!-- Test de reglas de Storage -->
        <div class="test-section">
            <h2>üìã Test de Reglas de Storage</h2>
            <button class="btn btn-primary" onclick="testStorageRules()">üîç Verificar Reglas de Storage</button>
            <div id="rulesResult"></div>
        </div>

        <!-- Configuraci√≥n actual -->
        <div class="test-section">
            <h2>‚öôÔ∏è Configuraci√≥n Actual</h2>
            <div id="configInfo"></div>
        </div>

        <!-- Log de actividad -->
        <div class="test-section">
            <h2>üìä Log de Actividad</h2>
            <button class="btn btn-primary" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
            <div id="activityLog" class="log"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBoYEWeYYmhiFadOFlA2SmMFuZab8tMtVU",
            authDomain: "design-reyes.firebaseapp.com",
            projectId: "design-reyes",
            storageBucket: "design-reyes.appspot.com",
            messagingSenderId: "454744557781",
            appId: "1:454744557781:web:ed4eaf82abdcc79e2afa5c",
            measurementId: "G-KCEX0JCC76"
        };

        let app, auth, storage, db;
        let selectedFile = null;
        let currentUser = null;

        // Funci√≥n para logging
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="level ${level}">${level}</span>
                ${message}
            `;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${level}] ${message}`);
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
        }

        // Inicializar Firebase
        async function initializeFirebase() {
            try {
                log('INFO', 'üî• Inicializando Firebase...');
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                storage = firebase.storage();
                db = firebase.firestore();
                
                document.getElementById('connectionStatus').innerHTML = '‚úÖ Firebase conectado correctamente';
                document.getElementById('connectionStatus').className = 'status success';
                log('SUCCESS', '‚úÖ Firebase inicializado correctamente');

                // Mostrar configuraci√≥n
                showConfiguration();

                // Verificar autenticaci√≥n
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('authStatus').innerHTML = `‚úÖ Usuario autenticado: ${user.email}`;
                        document.getElementById('authStatus').className = 'status success';
                        document.getElementById('userInfo').innerHTML = `
                            <div class="status success">
                                üë§ Usuario: ${user.email}<br>
                                üÜî UID: ${user.uid}
                            </div>
                        `;
                        document.getElementById('loginBtn').style.display = 'none';
                        document.getElementById('logoutBtn').style.display = 'inline-block';
                        document.getElementById('uploadBtn').disabled = !selectedFile;
                        log('SUCCESS', `üë§ Usuario autenticado: ${user.email}`);
                    } else {
                        currentUser = null;
                        document.getElementById('authStatus').innerHTML = '‚ùå Usuario no autenticado';
                        document.getElementById('authStatus').className = 'status error';
                        document.getElementById('userInfo').innerHTML = `
                            <div class="status warning">
                                ‚ö†Ô∏è Debes iniciar sesi√≥n para subir archivos
                            </div>
                        `;
                        document.getElementById('loginBtn').style.display = 'inline-block';
                        document.getElementById('logoutBtn').style.display = 'none';
                        document.getElementById('uploadBtn').disabled = true;
                        log('WARNING', '‚ö†Ô∏è Usuario no autenticado');
                    }
                });

                // Verificar Storage
                try {
                    const storageRef = storage.ref();
                    await storageRef.listAll();
                    document.getElementById('storageStatus').innerHTML = '‚úÖ Firebase Storage accesible';
                    document.getElementById('storageStatus').className = 'status success';
                    log('SUCCESS', '‚úÖ Firebase Storage accesible');
                } catch (error) {
                    document.getElementById('storageStatus').innerHTML = `‚ùå Error en Storage: ${error.message}`;
                    document.getElementById('storageStatus').className = 'status error';
                    log('ERROR', `‚ùå Error en Storage: ${error.message}`);
                }

            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
                document.getElementById('connectionStatus').className = 'status error';
                log('ERROR', `‚ùå Error inicializando Firebase: ${error.message}`);
            }
        }

        function showConfiguration() {
            document.getElementById('configInfo').innerHTML = `
                <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; font-family: monospace;">
                    <strong>üîß Configuraci√≥n Firebase:</strong><br>
                    ‚Ä¢ Project ID: ${firebaseConfig.projectId}<br>
                    ‚Ä¢ Auth Domain: ${firebaseConfig.authDomain}<br>
                    ‚Ä¢ Storage Bucket: ${firebaseConfig.storageBucket}<br>
                    ‚Ä¢ App ID: ${firebaseConfig.appId}
                </div>
            `;
        }

        async function testLogin() {
            try {
                log('INFO', 'üîë Iniciando sesi√≥n de prueba...');
                // Redirigir al login real
                const loginURL = window.location.origin + '/templates/login.html';
                window.open(loginURL, '_blank');
                log('INFO', 'üì± Abriendo p√°gina de login en nueva pesta√±a');
            } catch (error) {
                log('ERROR', `‚ùå Error en login: ${error.message}`);
            }
        }

        async function testLogout() {
            try {
                log('INFO', 'üö™ Cerrando sesi√≥n...');
                await auth.signOut();
                log('SUCCESS', '‚úÖ Sesi√≥n cerrada correctamente');
            } catch (error) {
                log('ERROR', `‚ùå Error cerrando sesi√≥n: ${error.message}`);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('fileInfo').innerHTML = `
                    <strong>üìÅ Archivo seleccionado:</strong><br>
                    ‚Ä¢ Nombre: ${file.name}<br>
                    ‚Ä¢ Tipo: ${file.type}<br>
                    ‚Ä¢ Tama√±o: ${fileSize} MB
                `;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('uploadBtn').disabled = !currentUser;
                log('INFO', `üìÅ Archivo seleccionado: ${file.name} (${fileSize} MB)`);
            }
        }

        async function testUpload() {
            if (!selectedFile || !currentUser) {
                log('ERROR', '‚ùå No hay archivo seleccionado o usuario no autenticado');
                return;
            }

            try {
                log('INFO', `üì§ Iniciando subida de ${selectedFile.name}...`);
                
                // Mostrar progreso
                document.getElementById('uploadProgress').style.display = 'block';
                const progressBar = document.getElementById('progressBar');
                
                // Crear referencia en Storage
                const timestamp = Date.now();
                const fileName = `test_uploads/${timestamp}_${selectedFile.name}`;
                const storageRef = storage.ref(fileName);
                
                log('INFO', `üìç Ruta de subida: ${fileName}`);
                
                // Subir archivo
                const uploadTask = storageRef.put(selectedFile);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        log('INFO', `üìä Progreso: ${progress.toFixed(1)}%`);
                    },
                    (error) => {
                        log('ERROR', `‚ùå Error en subida: ${error.message}`);
                        document.getElementById('uploadResult').innerHTML = `
                            <div class="status error">
                                ‚ùå Error en subida: ${error.message}<br>
                                C√≥digo: ${error.code}
                            </div>
                        `;
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            log('SUCCESS', `‚úÖ Archivo subido correctamente`);
                            log('SUCCESS', `üîó URL: ${downloadURL}`);
                            
                            document.getElementById('uploadResult').innerHTML = `
                                <div class="status success">
                                    ‚úÖ Archivo subido correctamente<br>
                                    üìç Ruta: ${fileName}<br>
                                    üîó <a href="${downloadURL}" target="_blank" style="color: #4CAF50;">Ver archivo</a>
                                </div>
                            `;
                            
                            // Resetear
                            selectedFile = null;
                            document.getElementById('testFile').value = '';
                            document.getElementById('fileInfo').style.display = 'none';
                            document.getElementById('uploadBtn').disabled = true;
                            document.getElementById('uploadProgress').style.display = 'none';
                            progressBar.style.width = '0%';
                            
                        } catch (error) {
                            log('ERROR', `‚ùå Error obteniendo URL: ${error.message}`);
                        }
                    }
                );
                
            } catch (error) {
                log('ERROR', `‚ùå Error en testUpload: ${error.message}`);
                document.getElementById('uploadResult').innerHTML = `
                    <div class="status error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testStorageRules() {
            try {
                log('INFO', 'üìã Verificando reglas de Storage...');
                
                const tests = [];
                
                // Test 1: Acceso sin autenticaci√≥n
                try {
                    const storageRef = storage.ref('test_uploads/test.txt');
                    await storageRef.getDownloadURL();
                    tests.push('‚ùå ERROR: Acceso sin autenticaci√≥n permitido (reglas muy permisivas)');
                } catch (error) {
                    if (error.code === 'storage/object-not-found') {
                        tests.push('‚úÖ OK: Archivo de prueba no existe (normal)');
                    } else if (error.code === 'storage/unauthorized') {
                        tests.push('‚úÖ OK: Acceso sin autenticaci√≥n bloqueado correctamente');
                    } else {
                        tests.push(`‚ö†Ô∏è WARNING: Error inesperado: ${error.code}`);
                    }
                }
                
                // Test 2: Estructura de carpetas
                if (currentUser) {
                    try {
                        const testRef = storage.ref(`designs/${currentUser.uid}/test.txt`);
                        tests.push('‚úÖ OK: Puede crear referencias en carpeta designs/');
                    } catch (error) {
                        tests.push(`‚ùå ERROR: No puede crear referencias: ${error.message}`);
                    }
                } else {
                    tests.push('‚ö†Ô∏è WARNING: No se puede probar acceso autenticado (usuario no logueado)');
                }
                
                document.getElementById('rulesResult').innerHTML = `
                    <div style="margin-top: 15px;">
                        <h4>üîç Resultados de las pruebas:</h4>
                        ${tests.map(test => `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">${test}</div>`).join('')}
                    </div>
                `;
                
                log('SUCCESS', 'üìã Verificaci√≥n de reglas completada');
                
            } catch (error) {
                log('ERROR', `‚ùå Error verificando reglas: ${error.message}`);
            }
        }

        // Inicializar cuando cargue la p√°gina
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>