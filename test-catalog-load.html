<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carga de Cat√°logo - Design Reyes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .status.loading { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }
        .status.success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .status.error { background: #ffebee; border-color: #f44336; color: #c62828; }
        .btn {
            background: #6236ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #7150ff; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .grid-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        .card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test de Carga de Cat√°logo</h1>
        
        <div id="status" class="status loading">
            üîÑ Iniciando pruebas...
        </div>
        
        <div style="margin: 20px 0;">
            <button class="btn" onclick="testConnection()">üîó Test Conexi√≥n Firebase</button>
            <button class="btn" onclick="testCatalogLoad()">üìö Test Carga Cat√°logo</button>
            <button class="btn" onclick="testFunctions()">‚öôÔ∏è Test Funciones</button>
            <button class="btn" onclick="clearLog()">üßπ Limpiar Log</button>
        </div>
        
        <div class="log" id="logContainer">
            [INICIANDO] Sistema de pruebas cargado...<br>
        </div>
        
        <h3>üìä Resultados del Cat√°logo:</h3>
        <div class="grid-preview" id="catalogPreview">
            <!-- Los dise√±os aparecer√°n aqu√≠ -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBoYEWeYYmhiFadOFlA2SmMFuZab8tMtVU",
            authDomain: "design-reyes.firebaseapp.com",
            projectId: "design-reyes",
            storageBucket: "design-reyes.appspot.com",
            messagingSenderId: "454744557781",
            appId: "1:454744557781:web:ed4eaf82abdcc79e2afa5c",
            measurementId: "G-KCEX0JCC76"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        log('‚úÖ Firebase inicializado correctamente');
    </script>
    
    <script>
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function setStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '[LIMPIADO] Log reiniciado...<br>';
        }
        
        async function testConnection() {
            log('üîó Probando conexi√≥n a Firebase...');
            setStatus('üîó Probando conexi√≥n...', 'loading');
            
            try {
                // Test b√°sico de conexi√≥n
                const testDoc = await db.collection('test').limit(1).get();
                log('‚úÖ Conexi√≥n a Firestore exitosa');
                
                // Test de autenticaci√≥n
                const currentUser = auth.currentUser;
                log(`üë§ Usuario actual: ${currentUser ? currentUser.email : 'No autenticado'}`);
                
                setStatus('‚úÖ Conexi√≥n exitosa', 'success');
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`);
                setStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }
        
        async function testCatalogLoad() {
            log('üìö Probando carga del cat√°logo...');
            setStatus('üìö Cargando cat√°logo...', 'loading');
            
            try {
                const snapshot = await db.collection('designs')
                    .orderBy('createdAt', 'desc')
                    .get({ source: 'server' });
                
                log(`üìä Dise√±os encontrados: ${snapshot.size}`);
                
                if (snapshot.empty) {
                    log('üì≠ No hay dise√±os en la base de datos');
                    setStatus('üì≠ Cat√°logo vac√≠o', 'error');
                    return;
                }
                
                // Mostrar dise√±os
                const catalogPreview = document.getElementById('catalogPreview');
                catalogPreview.innerHTML = '';
                
                let validDesigns = 0;
                let invalidDesigns = 0;
                
                snapshot.forEach(doc => {
                    const design = doc.data();
                    
                    // Validar estructura
                    if (!design.name || !design.category) {
                        invalidDesigns++;
                        log(`‚ö†Ô∏è Dise√±o inv√°lido encontrado: ${doc.id}`);
                        return;
                    }
                    
                    validDesigns++;
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <img src="${design.imageUrl || '../img/placeholder.svg'}" alt="${design.name}" onerror="this.src='../img/placeholder.svg'">
                        <h4>${design.name}</h4>
                        <p>üìÅ ${design.category}</p>
                        <p>üí∞ ${design.priceType === 'gratis' || parseFloat(design.price || 0) === 0 ? 'GRATIS' : `S/ ${parseFloat(design.price || 0).toFixed(2)}`}</p>
                        <small>ID: ${doc.id}</small>
                    `;
                    catalogPreview.appendChild(card);
                });
                
                log(`‚úÖ Dise√±os v√°lidos: ${validDesigns}`);
                log(`‚ö†Ô∏è Dise√±os con problemas: ${invalidDesigns}`);
                
                setStatus(`‚úÖ Cat√°logo cargado: ${validDesigns} dise√±os`, 'success');
                
            } catch (error) {
                log(`‚ùå Error cargando cat√°logo: ${error.message}`);
                setStatus('‚ùå Error cargando cat√°logo', 'error');
            }
        }
        
        async function testFunctions() {
            log('‚öôÔ∏è Probando funciones del sistema...');
            
            // Test variables globales
            if (typeof window.forceReloadCatalog === 'function') {
                log('‚úÖ forceReloadCatalog est√° disponible');
            } else {
                log('‚ùå forceReloadCatalog NO est√° disponible');
            }
            
            if (typeof window.handleDownloadClick === 'function') {
                log('‚úÖ handleDownloadClick est√° disponible');
            } else {
                log('‚ùå handleDownloadClick NO est√° disponible');
            }
            
            if (typeof window.viewDesignDetails === 'function') {
                log('‚úÖ viewDesignDetails est√° disponible');
            } else {
                log('‚ùå viewDesignDetails NO est√° disponible');
            }
            
            // Test elementos DOM
            const catalogoGrid = document.getElementById('catalogoGrid');
            if (catalogoGrid) {
                log('‚úÖ catalogoGrid elemento encontrado en DOM');
            } else {
                log('‚ùå catalogoGrid elemento NO encontrado en DOM');
            }
        }
        
        // Auto-inicio de pruebas
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Iniciando pruebas autom√°ticas...');
            await testConnection();
            await testCatalogLoad();
            testFunctions();
        });
    </script>
</body>
</html>